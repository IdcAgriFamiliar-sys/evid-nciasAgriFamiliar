<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGAF - Atividades da Família Agrícola</title>
    <!-- Carregando Tailwind CSS para estilização e fonte Inter -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* Fundo cinza claro */
        }
        .header-bg {
            background-color: #10b981; /* Verde esmeralda (cor do SIGAF) */
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border-radius: 0.75rem; /* rounded-xl */
        }
        .error-message {
            background-color: #fef2f2; /* Vermelho muito claro */
            border-left: 4px solid #ef4444; /* Borda vermelha */
            color: #ef4444; /* Texto vermelho */
        }
        .success-message {
            background-color: #ecfdf5; /* Verde muito claro */
            border-left: 4px solid #10b981; /* Borda verde */
            color: #059669; /* Texto verde */
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Configuração de Firebase e Auth (Imports e Inicialização) -->
    <script type="module">
        // Importações de Módulos
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais (fornecidas pelo ambiente Canvas/Firebase)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = 'loading';
        let isAuthReady = false;

        // Ativa o log de debug do Firestore
        setLogLevel('debug');

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Referências ao DOM (Elementos HTML)
        const userIdDisplay = document.getElementById('user-id-display');
        const loginMessage = document.getElementById('login-message');
        const activityList = document.getElementById('activity-list');
        const form = document.getElementById('activity-form');
        const statusMessage = document.getElementById('status-message');

        // Função para exibir mensagens de status
        const showStatus = (message, type = 'error') => {
            statusMessage.textContent = message;
            statusMessage.className = `p-3 mb-4 rounded-xl text-sm transition-all duration-300 ${type === 'success' ? 'success-message' : 'error-message'}`;
            statusMessage.style.display = 'block';
            setTimeout(() => {
                statusMessage.style.display = 'none';
                statusMessage.textContent = '';
            }, 5000);
        };

        // 1. Inicializa a autenticação e monitora o estado
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = `ID de Usuário: ${userId}`;
                loginMessage.style.display = 'none';
                isAuthReady = true;

                // Após a autenticação, inicie o listener do Firestore
                setupFirestoreListener();

            } else {
                // Tenta fazer login com o token fornecido ou anonimamente
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    showStatus(`Erro: ${error.message}. Falha na autenticação.`, 'error');
                }
            }
        });

        // 2. Listener de Atividades (Apenas após a autenticação)
        const setupFirestoreListener = () => {
            if (!isAuthReady || !db) return;

            // Caminho para a coleção: /artifacts/{appId}/users/{userId}/activities
            const activitiesPath = `/artifacts/${appId}/users/${userId}/activities`;
            const q = collection(db, activitiesPath);

            onSnapshot(q, (snapshot) => {
                let items = [];
                snapshot.forEach((doc) => {
                    items.push({ id: doc.id, ...doc.data() });
                });

                // Ordenar por data de criação (em memória)
                items.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

                renderActivities(items);

            }, (error) => {
                showStatus(`Erro ao carregar atividades: ${error.message}`, 'error');
            });
        };

        // 3. Renderiza a lista de atividades no DOM
        const renderActivities = (activities) => {
            activityList.innerHTML = ''; // Limpa a lista atual

            if (activities.length === 0) {
                activityList.innerHTML = `
                    <p class="text-gray-500 italic p-4 text-center bg-white rounded-xl">
                        Nenhuma atividade registrada ainda. Use o formulário acima para começar!
                    </p>
                `;
                return;
            }

            activities.forEach(activity => {
                const item = document.createElement('div');
                item.className = 'card bg-white p-4 mb-3 border-l-4 border-green-500 transition duration-150 ease-in-out hover:shadow-lg';
                
                const title = activity.title || 'Título não fornecido';
                const description = activity.description || 'Nenhuma descrição.';
                const date = activity.createdAt ? new Date(activity.createdAt).toLocaleDateString('pt-BR') : 'Sem Data';

                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-lg font-bold text-gray-800">${title}</h3>
                        <span class="text-xs text-gray-400 mt-1">${date}</span>
                    </div>
                    <p class="text-gray-600 mt-1 text-sm whitespace-pre-wrap">${description}</p>
                `;
                activityList.appendChild(item);
            });
        };

        // 4. Manipula o envio do formulário
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) {
                showStatus("Aguarde a autenticação para adicionar atividades.", 'error');
                return;
            }

            const title = document.getElementById('activity-title').value.trim();
            const description = document.getElementById('activity-description').value.trim();

            if (!title) {
                showStatus("O Título da atividade é obrigatório.", 'error');
                return;
            }

            try {
                const activitiesPath = `/artifacts/${appId}/users/${userId}/activities`;
                await addDoc(collection(db, activitiesPath), {
                    title: title,
                    description: description,
                    createdAt: Date.now() // Timestamp para ordenação
                });

                showStatus("Atividade adicionada com sucesso!", 'success');
                form.reset(); // Limpa o formulário
            } catch (error) {
                showStatus(`Erro ao salvar atividade: ${error.message}`, 'error');
            }
        });
    </script>

    <!-- Cabeçalho (Header) -->
    <header class="header-bg text-white p-4 shadow-md">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">SIGAF</h1>
            <span id="user-id-display" class="text-sm font-light">ID de Usuário: Carregando...</span>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4">
        
        <!-- Mensagens de Status e Login -->
        <div id="status-message" style="display: none;"></div>

        <div id="login-message" class="error-message p-3 mb-4 rounded-xl text-sm" style="display: block;">
            <p>Carregando dados... Por favor, aguarde a autenticação. Isso só ocorre na primeira vez.</p>
        </div>

        <!-- Formulário de Nova Atividade -->
        <div class="card bg-white p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">
                Nova Atividade ou Planejamento
            </h2>
            <form id="activity-form">
                <div class="mb-4">
                    <label for="activity-title" class="block text-sm font-medium text-gray-700 mb-1">
                        Título (Ex: Plantio de Milho) <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="activity-title" placeholder="O que precisa ser feito?" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="mb-6">
                    <label for="activity-description" class="block text-sm font-medium text-gray-700 mb-1">
                        Descrição (Detalhes, insumos, local)
                    </label>
                    <textarea id="activity-description" rows="4" placeholder="Detalhes, insumos necessários, local da atividade..."
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 resize-y"></textarea>
                </div>
                <button type="submit" class="w-full bg-green-500 text-white p-3 rounded-lg font-semibold hover:bg-green-600 transition duration-200 shadow-md">
                    Adicionar Atividade
                </button>
            </form>
        </div>

        <!-- Lista de Atividades Registradas -->
        <h2 class="text-2xl font-bold text-gray-800 mb-4">
            Atividades Registradas
        </h2>
        <div id="activity-list" class="space-y-3">
            <!-- As atividades serão renderizadas aqui pelo JavaScript -->
            <p class="text-gray-500 italic p-4 text-center bg-white rounded-xl">
                Carregando lista de atividades...
            </p>
        </div>
    </main>

</body>
</html>
